{{define "version_form"}}
{{template "layout" .}}
{{end}}

{{define "content"}}
<a href="/mods/{{.Mod.ID}}/versions" class="back-link">← バージョン一覧に戻る</a>

<div class="card">
    <div class="card-header">
        <h2>{{if .Version.ID}}バージョン編集: {{.Version.ID}}{{else}}新規バージョン作成{{end}}</h2>
    </div>
    <div class="card-body">
        {{if not .Version.ID}}
        <div class="import-section mb-5 pb-5 border-b border-gray-200">
            <h3>GitHubからインポート</h3>
            <div class="flex flex-col md:flex-row gap-2 mt-2">
                <input type="text" id="github-repo" placeholder="owner/repo (例: ikafly144/au_mod_installer)" class="flex-grow p-2 w-full">
                <div class="flex gap-2">
                    <button type="button" class="btn btn-secondary flex-1 md:flex-none" onclick="fetchGitHubRelease()">最新を取得</button>
                    <button type="button" class="btn btn-secondary flex-1 md:flex-none" onclick="showReleaseModal()">一覧から選択</button>
                </div>
            </div>
        </div>
        {{end}}

        <form id="version-form" onsubmit="return false;">
            <input type="hidden" id="version-editing" value="{{if .Version.ID}}{{.Version.ID}}{{end}}">
            
            <div class="form-group">
                <label for="version-id">バージョン *</label>
                <input type="text" id="version-id" name="id" required placeholder="例: 1.0.0" value="{{if .Version.ID}}{{.Version.ID}}{{end}}" {{if .Version.ID}}disabled{{end}}>
            </div>

            <div class="form-group">
                <label>対象AUバージョン</label>
                <div id="game-version-list" class="dynamic-list"></div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addGameVersion()">+ 追加</button>
            </div>
            
            <!-- For Mod/Plugin/Library -->
            <div id="group-files" class="form-group">
                <label>ファイル</label>
                <div id="files-list" class="dynamic-list"></div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addFile()">+ 追加</button>
            </div>
            <div id="group-deps" class="form-group">
                <label>依存関係</label>
                <div id="deps-list" class="dynamic-list"></div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addDep()">+ 追加</button>
            </div>

            <!-- For ModPack -->
            <div id="group-mods" class="form-group" style="display: none;">
                <label>同梱Mod</label>
                <div id="mods-list" class="dynamic-list"></div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addMod()">+ 追加</button>
            </div>

            <div class="form-actions mt-5">
                <button class="btn btn-primary" onclick="saveVersion()">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- Release Selection Modal -->
<div id="release-modal" class="modal">
    <div class="modal-content !max-w-4xl">
        <div class="modal-header">
            <h3>リリース選択</h3>
            <button class="modal-close" onclick="closeReleaseModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="release-list" class="max-h-[400px] overflow-y-auto">
                <!-- List will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Datalists for autocomplete -->
<datalist id="all-mods-list"></datalist>
{{end}}

{{define "scripts"}}
<script>
    const modId = '{{.Mod.ID}}';
    const modType = '{{.Mod.Type}}';
    // Pre-loaded version data for edit mode
    const versionData = {{if .Version}}{{json .Version}}{{else}}null{{end}};
    
    // Cache for versions
    const versionsCache = {};

    // UI Helpers
    function createItem(html) {
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.innerHTML = html + '<button type="button" class="btn-remove" onclick="this.parentElement.remove()">×</button>';
        return div;
    }

    function addGameVersion(version = '') {
        const html = `
            <input type="text" class="game-version flex-grow" placeholder="例: 2024.3.5" value="${version}">
        `;
        document.getElementById('game-version-list').appendChild(createItem(html));
    }

    function addFile(data = {}) {
        const html = `
            <input type="text" class="file-url flex-grow" placeholder="URL" value="${data.url || ''}">
            <select class="file-type w-100">
                <option value="normal" ${data.file_type === 'normal' ? 'selected' : ''}>Normal</option>
                <option value="zip" ${data.file_type === 'zip' ? 'selected' : ''}>Zip</option>
            </select>
            <input type="text" class="file-path w-150" placeholder="展開パス (任意)" value="${data.path || ''}">
            <label><input type="checkbox" class="file-comp-x86" ${(data.compatible || []).includes('x86') ? 'checked' : ''}> x86</label>
            <label><input type="checkbox" class="file-comp-x64" ${(data.compatible || []).includes('x64') ? 'checked' : ''}> x64</label>
        `;
        document.getElementById('files-list').appendChild(createItem(html));
    }

    function addDep(data = {}) {
        const uniqueId = 'dep-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const html = `
            <input type="text" class="dep-id flex-grow" placeholder="Mod ID" value="${data.id || ''}" list="all-mods-list" onchange="onModIdChange(this)">
            <input type="text" class="dep-version w-100" placeholder="Version" value="${data.version || ''}" list="${uniqueId}" onfocus="onVersionFocus(this)">
            <datalist id="${uniqueId}"></datalist>
            <select class="dep-type w-100">
                <option value="required" ${data.type === 'required' ? 'selected' : ''}>必須</option>
                <option value="optional" ${data.type === 'optional' ? 'selected' : ''}>任意</option>
                <option value="conflict" ${data.type === 'conflict' ? 'selected' : ''}>競合</option>
                <option value="embedded" ${data.type === 'embedded' ? 'selected' : ''}>埋込</option>
            </select>
        `;
        document.getElementById('deps-list').appendChild(createItem(html));
    }

    function addMod(data = {}) {
        const uniqueId = 'mod-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const html = `
            <input type="text" class="mod-id flex-grow" placeholder="Mod ID" value="${data.id || ''}" list="all-mods-list" onchange="onModIdChange(this)">
            <input type="text" class="mod-version w-100" placeholder="Version" value="${data.version || ''}" list="${uniqueId}" onfocus="onVersionFocus(this)">
            <datalist id="${uniqueId}"></datalist>
        `;
        document.getElementById('mods-list').appendChild(createItem(html));
    }

    async function loadAllMods() {
        try {
            const mods = await api('/mods');
            const datalist = document.getElementById('all-mods-list');
            datalist.innerHTML = '';
            mods.forEach(mod => {
                const option = document.createElement('option');
                option.value = mod.id;
                option.textContent = mod.name; // Shows as "id (name)" or similar in some browsers, or just value
                datalist.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to load mods:', error);
        }
    }

    async function fetchGitHubRelease(tag = null) {
        const repo = document.getElementById('github-repo').value.trim();
        if (!repo) {
            showToast('リポジトリを入力してください', 'error');
            return;
        }

        try {
            let url = `/github/releases/latest?repo=${repo}`;
            if (tag) {
                url = `/github/releases/info?repo=${repo}&tag=${tag}`;
            }
            
            const release = await api(url);
            
            // Set version ID
            let version = release.tag_name;
            if (version.startsWith('v')) version = version.substring(1);
            document.getElementById('version-id').value = version;

            // Add files
            // document.getElementById('files-list').innerHTML = ''; // Keep existing?
            release.assets.forEach(asset => {
                let type = 'normal';
                if (asset.name.endsWith('.zip')) type = 'zip';
                
                addFile({
                    url: asset.browser_download_url,
                    file_type: type,
                    path: ''
                });
            });
            
            showToast('GitHubから情報を取得しました');
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function showReleaseModal() {
        const repo = document.getElementById('github-repo').value.trim();
        if (!repo) {
            showToast('リポジトリを入力してください', 'error');
            return;
        }

        try {
            const releases = await api(`/github/releases?repo=${repo}`);
            const list = document.getElementById('release-list');
            list.innerHTML = '';

            if (releases.length === 0) {
                list.innerHTML = '<p class="text-gray-500 p-4">リリースが見つかりませんでした</p>';
            } else {
                const div = document.createElement('div');
                div.className = 'table-responsive';
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">タグ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名前</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">公開日</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                `;
                const tbody = table.querySelector('tbody');
                
                releases.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap font-mono text-sm">${r.tag_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.name || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(r.published_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="btn btn-sm btn-primary" onclick="selectRelease('${r.tag_name}')">選択</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                div.appendChild(table);
                list.appendChild(div);
            }

            document.getElementById('release-modal').classList.add('active');
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function closeReleaseModal() {
        document.getElementById('release-modal').classList.remove('active');
    }

    function selectRelease(tag) {
        closeReleaseModal();
        fetchGitHubRelease(tag);
    }

    function onModIdChange(input) {
        // Clear version input when mod ID changes
        const row = input.parentElement;
        const versionInput = row.querySelector('input[placeholder="Version"]');
        if (versionInput) {
            versionInput.value = '';
        }
    }

    async function onVersionFocus(input) {
        const row = input.parentElement;
        const modIdInput = row.querySelector('input[placeholder="Mod ID"]');
        if (!modIdInput || !modIdInput.value) return;

        const targetModId = modIdInput.value;
        const datalistId = input.getAttribute('list');
        const datalist = document.getElementById(datalistId);
        
        if (!datalist) return;

        // Use cached versions if available
        if (versionsCache[targetModId]) {
            updateVersionDatalist(datalist, versionsCache[targetModId]);
            return;
        }

        try {
            const versions = await api(`/mods/${targetModId}/versions`);
            versionsCache[targetModId] = versions;
            updateVersionDatalist(datalist, versions);
        } catch (error) {
            console.error(`Failed to load versions for ${targetModId}:`, error);
        }
    }

    function updateVersionDatalist(datalist, versions) {
        datalist.innerHTML = '';
        versions.forEach(v => {
            const option = document.createElement('option');
            option.value = v.id;
            datalist.appendChild(option);
        });
    }

    function initForm() {
        // Load mod list for autocomplete
        loadAllMods();

        // Toggle fields based on modType
        const isModPack = modType === 'modpack';
        document.getElementById('group-files').style.display = isModPack ? 'none' : 'block';
        document.getElementById('group-deps').style.display = isModPack ? 'none' : 'block';
        document.getElementById('group-mods').style.display = isModPack ? 'block' : 'none';

        if (versionData) {
            // Populate Target Versions
            if (versionData.target_version) {
                Object.entries(versionData.target_version).forEach(([k, v]) => addTarget(k, v));
            }
Game Versions
            if (versionData.game_versions && versionData.game_versions.length > 0) {
                versionData.game_versions.forEach(v => addGameVersion(v));
            } else if (versionData.target_version) {
                // Migration: show unique versions from target_version
                const seen = new Set();
                Object.values(versionData.target_version).forEach(v => {
                    if (!seen.has(v)) {
                        addGameVersion(v);
                        seen.add(v);
                    }
                }
            } else {
                (versionData.files || []).forEach(f => addFile(f));
                (versionData.dependencies || []).forEach(d => addDep(d));
            }
        }
    }

    async function saveVersion() {
        const editiGame Versions
        const game_versions = [];
        document.querySelectorAll('#game-version-list .dynamic-item').forEach(item => {
            const ver = item.querySelector('.game-version').value.trim();
            if (ver) game_versions.push(ver)
            return;
        }

        // Collect Target Versions
        const target_version = {};
        document.querySelectorAll('#target-list .dynamic-item').forEach(item => {
            const launcher = item.querySelector('.target-launcher').value;
            const ver = item.querySelector('.target-version').value.trim();
            if (launcher && ver) target_version[launcher] = ver;
        });

        let files = null;
        let dependencies = null;
        let mods = null;

        if (isModPack) {
            mods = [];
            document.querySelectorAll('#mods-list .dynamic-item').forEach(item => {
                const id = item.querySelector('.mod-id').value.trim();
                const ver = item.querySelector('.mod-version').value.trim();
                if (id) mods.push({ id, version: ver });
            });
        } else {
            files = [];
            document.querySelectorAll('#files-list .dynamic-item').forEach(item => {
                const url = item.querySelector('.file-url').value.trim();
                if (!url) return;
                const compatible = [];
                if (item.querySelector('.file-comp-x86').checked) compatible.push('x86');
                if (item.querySelector('.file-comp-x64').checked) compatible.push('x64');
                
                files.push({
                    url,
                    file_type: item.querySelector('.file-type').value,
                    path: item.querySelector('.file-path').value.trim(),
                    compatible
                });
            });

            dependencies = [];
            document.querySelectorAll('#deps-list .dynamic-item').forEach(item => {
                const id = item.querySelector('.dep-id').value.trim();
                if (!id) return;
                dependencies.push({
                    id,
            game_versionsn: item.querySelector('.dep-version').value.trim(),
                    type: item.querySelector('.dep-type').value
                });
            });
        }

        const version = {
            id: versionId,
            target_version,
            files,
            dependencies,
            mods
        };

        try {
            if (editing) {
                await api(`/mods/${modId}/versions/${versionId}`, 'PUT', version);
                showToast('バージョンを更新しました');
            } else {
                await api(`/mods/${modId}/versions`, 'POST', version);
                showToast('バージョンを作成しました');
            }
            // Redirect back to list
            setTimeout(() => {
                window.location.href = `/mods/${modId}/versions`;
            }, 500);
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initForm);
</script>
{{end}}
